<script>
  (function () {
    const dateEl = document.getElementById('date');
    const listEl = document.getElementById('list');
    const saveBtn = document.getElementById('saveBtn');
    const toastEl = document.getElementById('toast');

    // Stateful copy so we can save without re-reading DOM
    let state = { date: dateEl.value, roster: [] };

    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.style.display = 'block';
      setTimeout(() => (toastEl.style.display = 'none'), 1400);
    }

    function load(dateStr) {
      google.script.run
        .withSuccessHandler(render)
        .withFailureHandler(err => showToast('Load failed'))
        .api_getRosterAndAttendance(dateStr);
    }

    function render(payload) {
      state.date = payload.date;
      state.roster = payload.roster.slice(); // copy
      listEl.innerHTML = '';

      // We already get sorted order from server.
      // Create group headings when level/gender changes: Varsity M/F → JV M/F
      let lastGroup = '';
      state.roster.forEach((r, i) => {
        const group = `${r.level} ${r.gender}`;
        if (group !== lastGroup) {
          const gt = document.createElement('div');
          gt.className = 'groupTitle';
          gt.textContent = group;
          listEl.appendChild(gt);
          lastGroup = group;
        }

        const row = document.createElement('div');
        row.className = 'row';

        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = r.name;

        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.textContent = r.level;

        // Create attendance status buttons
        const attendanceDiv = document.createElement('div');
        attendanceDiv.className = 'attendance-status';

        const presentBtn = document.createElement('button');
        presentBtn.className = 'status-btn present';
        presentBtn.textContent = '✓';
        presentBtn.title = 'Present';

        const excusedBtn = document.createElement('button');
        excusedBtn.className = 'status-btn excused';
        excusedBtn.textContent = 'E';
        excusedBtn.title = 'Excused';

        const absentBtn = document.createElement('button');
        absentBtn.className = 'status-btn absent';
        absentBtn.textContent = '✗';
        absentBtn.title = 'Absent';

        // Set initial state
        function updateButtonStates() {
          presentBtn.classList.toggle('active', !!r.present && !r.excused);
          excusedBtn.classList.toggle('active', !!r.excused);
          absentBtn.classList.toggle('active', !r.present && !r.excused);
        }

        presentBtn.addEventListener('click', () => {
          r.present = true;
          r.excused = false;
          updateButtonStates();
        });

        excusedBtn.addEventListener('click', () => {
          r.present = false;
          r.excused = true;
          updateButtonStates();
        });

        absentBtn.addEventListener('click', () => {
          r.present = false;
          r.excused = false;
          updateButtonStates();
        });

        attendanceDiv.appendChild(presentBtn);
        attendanceDiv.appendChild(excusedBtn);
        attendanceDiv.appendChild(absentBtn);

        updateButtonStates();

        row.appendChild(name);
        row.appendChild(tag);
        row.appendChild(attendanceDiv);
        listEl.appendChild(row);
      });

      showToast('Loaded');
    }

    function save() {
      // Minimal payload
      const payload = state.roster.map(r => ({
        name: r.name,
        level: r.level,
        gender: r.gender,
        present: !!r.present,
        excused: !!r.excused,
      }));

      google.script.run
        .withSuccessHandler(() => showToast('Saved'))
        .withFailureHandler(err => showToast('Save failed'))
        .api_saveAttendance(state.date, payload);
    }

    // Events
    dateEl.addEventListener('change', () => {
      const d = dateEl.value;
      if (!d) return;
      load(d);
    });
    saveBtn.addEventListener('click', save);

    // Initial load
    load(dateEl.value);
  })();
</script>
